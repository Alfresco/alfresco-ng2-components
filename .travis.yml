language: node_js
dist: trusty
sudo: required
node_js:
 # Use the explicit NodeJS LTS version 8.9.4 to avoid any automatic upgrade of the version.
  - '8.9.4'

env:
  - AFFECTED_LIBS="core"

stages:
  - name: testcore
    if: env(AFFECTED_LIBS) = core
  - name: testcloud
    if: env(AFFECTED_LIBS) = process-services-cloud
  - name: deploy
    if: branch = master

addons:
    chrome: stable
before_script:
    - "sudo chown root /opt/google/chrome/chrome-sandbox"
    - "sudo chmod 4755 /opt/google/chrome/chrome-sandbox"

before_install:
    - export CHROME_BIN=chromium-browser
    - export DISPLAY=:99.0
    - sh -e /etc/init.d/xvfb start
    - sleep 3 # give xvfb some time to start


jobs:
  include:
    - stage: deploy
      script: echo  the deploy
    - stage: testcore
      env: STAGE=core
      script:
        AFFECTED_LIBS="$(./scripts/affected-libs.sh -b development)";
        echo "AFFECTED_LIBS $AFFECTED_LIBS";
        if [[ $AFFECTED_LIBS =~ "core$" ]];
        then
            echo "core";
            ng test core --watch=false || exit 1;
        else
            echo $AFFECTED_LIBS;
            echo "NO core";
        fi
    - stage: testcore
      env: STAGE=content-services
      script:
        ./scripts/affected-libs.sh -b development;
        if [[ $AFFECTED_LIBS =~ "content-services$" ]];
        then
            echo "content-services";
            ng test content-services --watch=false || exit 1;
        else
            echo "NO content-services";
        fi
    - stage: testcore
      env: STAGE=process-services
      script:
        ./scripts/affected-libs.sh -b development;
        if [[ $AFFECTED_LIBS =~ "process-services$" ]];
        then
            echo "process-services";
            ng test process-services --watch=false || exit 1;
        else
            echo "NO process-services";
        fi
    - stage: testcore
      env: STAGE=process-services-cloud
      script:
        AFFECTED_LIBS=(`echo ./scripts/affected-libs.sh -b development;`)
        if [[ $AFFECTED_LIBS =~ "process-services-cloud$" ]];
        then
            echo "process-services-cloud";
            ng test process-services-cloud --watch=false || exit 1;
        else
            echo "NO process-services-cloud";
        fi
    - stage: testcloud
      env: STAGE=cloud1
      script: echo cloud1
    - stage: testcloud
      env: STAGE=cloud2
      script: echo cloud2

# jobs:
#   include:
#     - stage: Publish alpha to NPM
#       before_install: skip
#       install: skip
#       script: skip
#       deploy:
#         provider: script
#         script: (./scripts/update-version.sh -v $(./scripts/next_version.sh)-$(git rev-parse HEAD) -vj $(npm view alfresco-js-api@alpha version) -gnu) && (./scripts/npm-publish.sh -r $NPM_REGISTRY_ADDRESS -token $NPM_REGISTRY_TOKEN -t alpha --sleep 20 || exit 1;);
#         on:
#           branch: development
#         skip_cleanup: true
#     - stage: Publish beta to NPM
#       before_install: skip
#       install: skip
#       script: skip
#       deploy:
#         provider: script
#         script: (./scripts/update-version.sh -v $TRAVIS_TAG -gnu) && (./scripts/npm-publish.sh -r $NPM_REGISTRY_ADDRESS -token $NPM_REGISTRY_TOKEN -t beta --sleep 20 || exit 1;);
#         on:
#           tags: true
#         skip_cleanup: true


# Send coverage data to codecov
after_success:
    bash <(curl -s https://codecov.io/bash) -X gcov


cache:
  directories:
  - node_modules
