git:
  depth: 3
  quiet: true
language: node_js
dist: trusty
sudo: required
node_js:
 # Use the explicit NodeJS LTS version 8.9.4 to avoid any automatic upgrade of the version.
  - '8.9.4'

install:
    echo "no install"

branches:
  only:
  - master
  - development
  - /.*next-release.*/
  - /.*beta.*/
  - /.*greenkeeper.*/

# TRAVIS_PULL_REQUEST == false means is running on dev branch and is not a PR
stages:
  - name: Warm Up Cache & Lint & Build Dist
  - name: Unit test
  - name: e2e Test
  - name: Create Docker PR
  - name: Deploy Docker PR

addons:
    chrome: stable
before_script:
    - "sudo chown root /opt/google/chrome/chrome-sandbox"
    - "sudo chmod 4755 /opt/google/chrome/chrome-sandbox"

before_install:
    - export CHROME_BIN=chromium-browser
    - export DISPLAY=:99.0
    - sh -e /etc/init.d/xvfb start
    - sleep 3 # give xvfb some time to start

jobs:
    include:
        - stage: Warm Up Cache & Lint & Build Dist
          script:
             ./scripts/travis/build/build.sh
        - stage: Unit test
          name: Unit test
          script: concurrently "./scripts/travis/unit-test/content.sh" "./scripts/travis/unit-test/core-extension-demo.sh" "./scripts/travis/unit-test/process.sh"
        - stage: Update children projects dependency #Update children projects dependency
          name: Update Generator
          if: tag =~ .*beta.*
          script: ./scripts/travis/e2e/update-project.sh
        - stage: e2e Test
          name: core and content
          script: concurrently "././scripts/travis/e2e/core-e2e.sh" "./scripts/travis/e2e/content-services-e2e.sh"
        - stage: e2e Test
          name: process
          script:
             concurrently "./scripts/travis/e2e/process-services-e2e.sh" " ./scripts/travis/e2e/process-services-cloud-e2e.sh" "./scripts/travis/e2e/insights-e2e.sh" "./scripts/travis/e2e/search-e2e.sh"
        - stage: Create Docker and Deploy Docker PR
          script:
          - if [ "$TRAVIS_PULL_REQUEST" != "false" ];
            then
              node ./scripts/move-dist-folder.js --base-href $TRAVIS_BUILD_NUMBER && (./scripts/pr-publish.sh -n $TRAVIS_BUILD_NUMBER -r $REPO_DOCKER -u $USERNAME_DOCKER -p $PASSWORD_DOCKER || exit 1);
            fi;
          - if [ "$TRAVIS_PULL_REQUEST" != "false" ];
            then
              (node --no-deprecation ./scripts/pr-deploy.js -n $TRAVIS_BUILD_NUMBER -u $RANCHER_TOKEN -p $RANCHER_SECRET -s $REPO_RANCHER --image "docker:$REPO_DOCKER/adf/demo-shell:$TRAVIS_BUILD_NUMBER" --env $ENVIRONMENT_NAME -r $ENVIRONMENT_URL || exit 1);
            fi;

# Send coverage data to codecov
after_success:
    bash <(curl -s https://codecov.io/bash) -X gcov

cache:
  directories:
  - node_modules
  - demo-shell/dist
  - tmp
