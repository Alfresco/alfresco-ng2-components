<div class="adf-metadata-properties">
    <mat-accordion displayMode="flat"
                   [multi]="multi">
        <mat-expansion-panel *ngIf="displayDefaultProperties"
                             [expanded]="canExpandProperties()"
                             [attr.data-automation-id]="'adf-metadata-group-properties'"
                             hideToggle
                             (opened)="toggleGeneralInfoPanel()"
                             (closed)="toggleGeneralInfoPanel()">
            <mat-expansion-panel-header>
                <div class="adf-metadata-properties-panel-content">
                    <mat-icon>
                        {{ isGeneralInfoPanelVisible ? 'expand_more' : 'chevron_right'}}
                    </mat-icon>
                    <mat-panel-title class="adf-metadata-properties-title">
                        {{ 'CORE.METADATA.BASIC.HEADER' | translate }}
                    </mat-panel-title>
                </div>
                <button *ngIf="hasToggleEdit"
                        mat-icon-button
                        (click)="toggleEdit($event, group, buttonType.GeneralInfo)"
                        [attr.title]="'CORE.METADATA.ACTIONS.EDIT' | translate"
                        [attr.aria-label]="'CORE.METADATA.ACCESSIBILITY.EDIT' | translate"
                        data-automation-id="meta-data-general-info-edit"
                        class="adf-edit-icon-buttons">
                    <mat-icon>mode_edit</mat-icon>
                </button>
                <div *ngIf="editable"
                    class="adf-metadata-action-buttons">
                    <button mat-icon-button 
                            [attr.title]="'CORE.METADATA.ACTIONS.CANCEL' | translate"
                            (click)="cancelChanges(buttonType.GeneralInfo, $event, group)"
                            data-automation-id="reset-metadata"
                            class="adf-metadata-action-buttons-clear">
                        <mat-icon>clear</mat-icon>
                    </button>
                    <button mat-icon-button
                            [attr.title]="'CORE.METADATA.ACTIONS.SAVE' | translate"
                            (click)="saveChanges(buttonType.GeneralInfo, $event, group)"
                            color="primary"
                            data-automation-id="save-general-info-metadata"
                            [disabled]="!hasMetadataChanged">
                        <mat-icon>check</mat-icon>
                    </button>
                </div>
            </mat-expansion-panel-header>
            <mat-divider class="adf-mat-divider"></mat-divider>
            <adf-card-view
                (keydown)="keyDown($event)"
                [properties]="basicProperties$ | async"
                [editable]="editable"
                [displayEmpty]="displayEmpty"
                [copyToClipboardAction]="copyToClipboardAction"
                [useChipsForMultiValueProperty]="useChipsForMultiValueProperty"
                [multiValueSeparator]="multiValueSeparator">
            </adf-card-view>
        </mat-expansion-panel>
        <ng-container *ngIf="displayTags">
            <mat-expansion-panel 
                            (opened)="toggleTagsPanel(true)"
                            (closed)="toggleTagsPanel(false)"
                            hideToggle
                            [expanded]="isTagPanelVisible">
                <mat-expansion-panel-header>
                    <div class="adf-metadata-properties-panel-content">
                        <mat-icon>
                            {{ isTagPanelVisible ? 'expand_more' : 'chevron_right'}}
                        </mat-icon>
                        <mat-panel-title class="adf-metadata-properties-title">
                            {{ 'METADATA.BASIC.TAGS' | translate }}
                        </mat-panel-title>
                    </div>
                    <div class="adf-tags-buttons">
                        <button *ngIf="hasTagsToggleEdit"
                                mat-icon-button
                                (click)="toggleEdit($event, group, buttonType.Tags)"
                                [attr.title]="'CORE.METADATA.ACTIONS.EDIT' | translate"
                                [attr.aria-label]="'CORE.METADATA.ACCESSIBILITY.EDIT' | translate"
                                data-automation-id="showing-tag-input-button"
                                class="adf-edit-icon-buttons">
                            <mat-icon>mode_edit</mat-icon>
                        </button>
                    </div>
                    <div *ngIf="editableTags" class="adf-metadata-action-buttons">
                        <button mat-icon-button
                                [attr.title]="'CORE.METADATA.ACTIONS.CANCEL' | translate"
                                (click)="cancelChanges(buttonType.Tags, $event, group)"
                                data-automation-id="reset-tags-metadata"
                                class="adf-metadata-action-buttons-clear">
                            <mat-icon>clear</mat-icon>
                        </button>
                        <button mat-icon-button
                                [attr.title]="'CORE.METADATA.ACTIONS.SAVE' | translate"
                                (click)="saveChanges(buttonType.Tags, $event, group)"
                                color="primary"
                                data-automation-id="save-tags-metadata"
                                [disabled]="!hasMetadataChanged">
                            <mat-icon>check</mat-icon>
                        </button>
                    </div>
                </mat-expansion-panel-header>
                <mat-divider class="adf-mat-divider"></mat-divider>
                <div
                    *ngIf="!editableTags"
                    class="adf-metadata-properties-tags">
                    <span *ngFor="let tag of tags" class="adf-metadata-properties-tag">{{ tag }}</span>
                </div>
                <div *ngIf="isTagsEmpty()" class="adf-metadata-no-item-added">
                    {{ 'METADATA.BASIC.NO_TAGS_ADDED' | translate }}
                </div>
                <div *ngIf="editableTags" class="adf-metadata-properties-tags">
                    <adf-tags-creator
                        [(tagNameControlVisible)]="tagNameControlVisible"
                        (tagsChange)="storeTagsToAssign($event)"
                        [mode]="tagsCreatorMode"
                        [tags]="assignedTags"
                        [disabledTagsRemoving]="saving">
                    </adf-tags-creator>
                </div>
            </mat-expansion-panel>
        </ng-container>
        <ng-container *ngIf="displayCategories">
            <mat-expansion-panel
                            (opened)="toggleCategoriesPanel(true)"
                            (closed)="toggleCategoriesPanel(false)"
                            hideToggle
                            [expanded]="isCategoriesPanelVisible">
                <mat-expansion-panel-header>
                    <div class="adf-metadata-properties-panel-content">
                        <mat-icon>
                            {{ isCategoriesPanelVisible ? 'expand_more' : 'chevron_right'}}</mat-icon>
                        <mat-panel-title class="adf-metadata-properties-title">
                            {{ 'CATEGORIES_MANAGEMENT.CATEGORIES_TITLE' | translate }}
                        </mat-panel-title>
                    </div>
                    <div class="adf-metadata-categories-title">
                        <button *ngIf="hasCategoriesToggleEdit"
                                mat-icon-button
                                (click)="toggleEdit($event, group, buttonType.Categories)"
                                [attr.title]="'CORE.METADATA.ACTIONS.EDIT' | translate"
                                [attr.aria-label]="'CORE.METADATA.ACCESSIBILITY.EDIT' | translate"
                                data-automation-id="meta-data-categories-edit"
                                class="adf-edit-icon-buttons">
                            <mat-icon>mode_edit</mat-icon>
                        </button>
                    </div>
                    <div *ngIf="editableCategories" class="adf-metadata-action-buttons">
                        <button mat-icon-button
                                [attr.title]="'CORE.METADATA.ACTIONS.CANCEL' | translate"
                                (click)="cancelChanges(buttonType.Categories, $event, group)"
                                data-automation-id="reset-metadata"
                                class="adf-metadata-action-buttons-clear">
                            <mat-icon>clear</mat-icon>
                        </button>
                        <button mat-icon-button
                                [attr.title]="'CORE.METADATA.ACTIONS.SAVE' | translate"
                                (click)="saveChanges(buttonType.Categories, $event, group)"
                                color="primary"
                                data-automation-id="save-categories-metadata"
                                [disabled]="!hasMetadataChanged">
                            <mat-icon>check</mat-icon>
                        </button>
                    </div>
                </mat-expansion-panel-header>
                <mat-divider class="adf-mat-divider"></mat-divider>
                <div *ngIf="!editableCategories">
                    <p *ngFor="let category of categories" class="adf-metadata-categories">{{ category.name }}</p>
                </div>
                <div *ngIf="isCategoryEmpty()" class="adf-metadata-no-item-added">
                    {{ 'CATEGORIES_MANAGEMENT.NO_CATEGORIES_ADDED' | translate }}
                </div>
                <div *ngIf="editableCategories" class="adf-metadata-categories-header">
                    <adf-categories-management
                        [(categoryNameControlVisible)]="categoryControlVisible"
                        [disableRemoval]="saving"
                        [categories]="categories"
                        [managementMode]="categoriesManagementMode"
                        [classifiableChanged]="classifiableChanged"
                        (categoriesChange)="storeCategoriesToAssign($event)">
                    </adf-categories-management>
                </div>
            </mat-expansion-panel>
        </ng-container>
        <mat-expansion-panel *ngFor="let customPanel of customPanels" [expanded]="canExpandTheCard(customPanel.panelTitle)">
            <mat-expansion-panel-header>
                <mat-panel-title>{{ customPanel.panelTitle | translate }}</mat-panel-title>
            </mat-expansion-panel-header>
            <adf-dynamic-component [id]="customPanel.component" [data]="{ node }"></adf-dynamic-component>
        </mat-expansion-panel>
            <ng-container *ngIf="groupedProperties$ | async; else loading; let groupedProperties">
                <div *ngFor="let group of groupedProperties; let first = first;"
                     class="adf-metadata-grouped-properties-container">
                    <mat-expansion-panel *ngIf="showGroup(group) || editable"
                                         [attr.data-automation-id]="'adf-metadata-group-' + group.title"
                                         [expanded]="canExpandTheCard(group.title) || !displayDefaultProperties && first"
                                         hideToggle>
                        <mat-expansion-panel-header>
                            <div class="adf-metadata-properties-panel-content">
                                <mat-icon>
                                    {{ group.expanded ? 'expand_more' : 'chevron_right'}}
                                </mat-icon>
                                <mat-panel-title class="adf-metadata-properties-title" matTooltip="{{ group.title | translate }}">
                                    <p class="adf-metadata-properties-group-title">
                                        {{ group.title | translate }}
                                    </p>
                                </mat-panel-title>
                            </div>
                            <button *ngIf="hasGroupToggleEdit(group)"
                                    mat-icon-button
                                    [attr.title]="'CORE.METADATA.ACTIONS.EDIT' | translate"
                                    [attr.aria-label]="'CORE.METADATA.ACCESSIBILITY.EDIT' | translate"
                                    data-automation-id="meta-data-card-toggle-edit"
                                    class="adf-edit-icon-buttons"
                                    (click)="toggleEdit($event, group, buttonType.Group)">
                                <mat-icon>mode_edit</mat-icon>
                            </button>
                            <div class="adf-metadata-action-buttons" *ngIf="group.editable">
                                <button mat-icon-button
                                        [attr.title]="'CORE.METADATA.ACTIONS.CANCEL' | translate"
                                        (click)="cancelChanges(buttonType.Group, $event, group)"
                                        data-automation-id="reset-metadata"
                                        class="adf-metadata-action-buttons-clear">
                                    <mat-icon>clear</mat-icon>
                                </button>
                                <button mat-icon-button
                                        [attr.title]="'CORE.METADATA.ACTIONS.SAVE' | translate"
                                        (click)="saveChanges(buttonType.Group, $event, group)"
                                        color="primary"
                                        data-automation-id="save-metadata"
                                        [disabled]="!hasMetadataChanged">
                                    <mat-icon>check</mat-icon>
                                </button>
                            </div>
                        </mat-expansion-panel-header>
                        <mat-divider class="adf-mat-divider"></mat-divider>
                        <div *ngIf="!showGroup(group) && !group.editable" class="adf-metadata-no-item-added">
                            {{ 'METADATA.BASIC.NO_ITEMS_MESSAGE' | translate: { groupTitle: group.title } }}
                        </div>
                        <adf-card-view
                            (keydown)="keyDown($event)"
                            [properties]="group.properties"
                            [editable]="group.editable"
                            [displayEmpty]="displayEmpty"
                            [copyToClipboardAction]="copyToClipboardAction"
                            [useChipsForMultiValueProperty]="useChipsForMultiValueProperty"
                            [multiValueSeparator]="multiValueSeparator"
                            [displayLabelForChips]="true">
                        </adf-card-view>
                    </mat-expansion-panel>
                </div>
            </ng-container>
            <ng-template #loading>
                <mat-progress-bar mode="indeterminate" [attr.aria-label]="'DATA_LOADING' | translate">
                </mat-progress-bar>
            </ng-template>
    </mat-accordion>
</div>
