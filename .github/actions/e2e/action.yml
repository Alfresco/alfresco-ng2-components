name: "e2e"
description: "e2e"
inputs:
  e2e-test-id:
    description: "Test id"
    required: true
  e2e-test-folder:
    description: "Test folder"
    required: true
  e2e-test-provider:
    description: "Test provider"
    required: true
  e2e-test-auth:
    description: "Test auth"
    required: true
  output:
    description: "Output path"
    required: true
  check-cs-env:
    required: true
    description: check cs env
    default: "false"
  check-ps-env:
    required: true
    description: check ps env
    default: "false"
  check-external-cs-env:
    required: true
    description: check external cs env
    default: "false"
  check-ps-cloud-env:
    required: true
    description: check ps cloud env
    default: "false"
  local-smart-runner-path: #
    required: false
    default: ".protractor-smartrunner"
  e2e-tar-name: #
    required: false
    default: e2e.tar.gz
  s3-build-path: #
    required: true

  apa-proxy-host:
    required: true
  e2e-proxy-host: #
    required: true
  apa-proxy: #
    description: "proxy host"
    required: true

runs:
  # description: try to download an e2e, if it was built previously
  using: "composite"
  steps:
    - name: setup proxy env var
      shell: bash
      run: |
        if [[ -z "${{ inputs.apa-proxy-host }}" ]]; then
          echo "APA proxy host not found. terminating"
          exit 1
        fi
        if [[ -z "${{ inputs.e2e-proxy-host }}" ]]; then
          echo "e2e proxy host not found. terminating"
          exit 1
        fi

        if [[ -z "${{ inputs.apa-proxy }}" ]]; then
          echo "Custom proxy not set. using default "
          echo "PROXY_HOST_BPM=${{ inputs.e2e-proxy-host }}" >> $GITHUB_ENV
        else
          echo "APA proxy set."
          echo "PROXY_HOST_BPM=${{ inputs.apa-proxy-host }}" >> $GITHUB_ENV
        fi

    - name: install aws cli
      shell: bash
      run: pip install awscli
    - name: download test from s3 bucket
      shell: bash
      env:
        FULL_REMOTE_PATH: ${{ inputs.s3-build-path }}/adf/smart-runner/${{ github.run_id}}/${{ inputs.e2e-test-folder }}-${{ inputs.e2e-test-id}}/e2e.tar.gz
      run: |
        set -u;
        mkdir -p "${{ inputs.local-smart-runner-path }}"
        if [[ $(aws s3 ls "${FULL_REMOTE_PATH}" > /dev/null; echo $?) -eq 0 ]]; then 
          echo "downloading test files"
          aws s3 cp "${FULL_REMOTE_PATH}" .;
          tar xzf ${{ inputs.e2e-tar-name }};
          ls -l "${{ inputs.local-smart-runner-path }}/";
        else
          echo "nothing to download";
        fi

    - name: reinstall testing
      shell: bash
      run: nx run testing:bundle

    - name: check EXTERNAL-CS is UP
      shell: bash
      if: ${{ inputs.check-external-cs-env == 'true' }}
      run: |
        set -u;
        ./node_modules/@alfresco/adf-cli/bin/adf-cli \
          check-cs-env \
          --host "$EXTERNAL_ACS_HOST" \
          -u "$E2E_USERNAME" \
          -p "$E2E_PASSWORD" || exit 1

    - name: Check CS is UP
      shell: bash
      if: ${{ inputs.check-cs-env == 'true' }}
      run: |
        set -u;
        ./node_modules/@alfresco/adf-cli/bin/adf-cli \
          check-cs-env \
          --host "$E2E_HOST" \
          -u "$E2E_USERNAME" \
          -p "$E2E_PASSWORD" || exit 1

    - name: check PS is UP
      shell: bash
      if: ${{ inputs.check-ps-env == 'true' }}
      run: |
        set -u;
        ./node_modules/@alfresco/adf-cli/bin/adf-cli init-aps-env \
          --host "$E2E_HOST" \
          -u "$E2E_USERNAME" \
          -p "$E2E_PASSWORD" \
          --license "$AWS_S3_BUCKET_ACTIVITI_LICENSE" || exit 1

    - name: check PS-CLOUD is UP
      shell: bash
      if: ${{ inputs.check-ps-cloud-env == 'true' }}
      run: |
        set -u;
        ./node_modules/@alfresco/adf-cli/bin/adf-cli init-aae-env \
          --oauth "$E2E_HOST" \
          --host "$E2E_HOST_APA" \
          --modelerUsername "$E2E_MODELER_USERNAME" \
          --modelerPassword "$E2E_MODELER_PASSWORD" \
          --devopsUsername "$E2E_DEVOPS_USERNAME" \
          --devopsPassword "$E2E_DEVOPS_PASSWORD" \
          --clientId 'alfresco' || exit 1

    - name: some debug
      env:
        FOLDER: "${{ inputs.e2e-test-folder }}"
        PROVIDER: "${{ inputs.e2e-test-provider }}"
        AUTH_TYPE: "${{ inputs.e2e-test-auth }}"
        E2E_TEST_ID: "${{ inputs.e2e-test-id }}"
      shell: bash
      run: |
        set -u;
        echo $PROXY_HOST_BPM
        NX_CALCULATION_FLAGS=$(echo $NX_CALCULATION_FLAGS | sed "s@'@@g")
        echo "NX_CALCULATION_FLAGS=$NX_CALCULATION_FLAGS" >> $GITHUB_ENV
        GIT_HASH=$(echo $GIT_HASH | sed "s@'@@g")
        echo "GIT_HASH=$GIT_HASH" >> $GITHUB_ENV
        echo GH_ACTION_RETRY_COUNT=0 >> $GITHUB_ENV

    - name: run test with retries
      id: retry_run
      env:
        FOLDER: "${{ inputs.e2e-test-folder }}"
        PROVIDER: "${{ inputs.e2e-test-provider }}"
        AUTH_TYPE: "${{ inputs.e2e-test-auth }}"
        E2E_TEST_ID: "${{ inputs.e2e-test-id }}"
      uses: nick-fields/retry@v2.8.2
      with:
        timeout_minutes: 20
        max_attempts: 2
        retry_wait_seconds: 30
        shell: bash
        command: |
          set -u;
          echo "+++ running new attempt #$GH_ACTION_RETRY_COUNT +++"
          bash ./scripts/travis/e2e/e2e.sh "$E2E_TEST_ID"
          GH_ACTION_RETRY_COUNT=$(( $GH_ACTION_RETRY_COUNT + 1 ))
          echo "GH_ACTION_RETRY_COUNT=$GH_ACTION_RETRY_COUNT" >> $GITHUB_ENV

    - name: up to s3
      shell: bash
      if: always()
      env:
        FULL_REMOTE_PATH: "${{ inputs.s3-build-path }}/adf/smart-runner/${{ github.run_id}}/${{ inputs.e2e-test-folder }}-${{ inputs.e2e-test-id}}/e2e.tar.gz"

      # description: always upload newer results
      run: |
        set -u;
        ls -lhart "${{ inputs.local-smart-runner-path }}"
        tar czf "${{ inputs.e2e-tar-name }}" "${{ inputs.local-smart-runner-path }}"
        aws s3 cp "${{ inputs.e2e-tar-name }}" "$FULL_REMOTE_PATH"
        rm -rf  "${{ inputs.local-smart-runner-path }}"
        rm -rf  "${{ inputs.e2e-tar-name }}"

    - name: upload 2e2 reports
      uses: actions/upload-artifact@v3
      continue-on-error: true
      with:
        path: e2e-output/
        name: dist-${{ github.ref_name }}-${{ inputs.e2e-test-id }}
