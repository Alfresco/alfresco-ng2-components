name: "Upload build artifacts"
description: "Upload build artifacts"
inputs:
  packages:
    description: 'packages to cache'
    required: false
    type: boolean
    default: 'dist'
  persistent-packages:
    description: 'cache key'
    required: false
    type: string
    default: 'nxcache'
  cache-key-suffix:
    description: 'cache key suffix'
    required: false
    type: string
    default: ''
runs:
  using: "composite"
  steps:
    - name: tar and upload artifacts
      shell: bash
      env:
       REMOTE_PATH: "alfresco-ng2-components/build-cache/${{ github.run_id }}"
      run: |
        packages=( $(echo ${{ inputs.packages }}) )
        for i in "${packages[@]}"; do
          time tar czf $i.tar.gz $i
          du -h $i.tar.gz
          time aws s3 cp --no-progress $i.tar.gz s3://${S3_BUILD_BUCKET_SHORT_NAME}/${REMOTE_PATH}/$i.tar.gz
        done
    - name: tar and upload persistent artifacts
      shell: bash
      run: |
        HASH=$(md5sum package-lock.json | cut -f 1 -d " ")
        REMOTE_PATH="alfresco-ng2-components/build-cache/${HASH}"
        if [ -n "${{ inputs.cache-key-suffix }}" ]; then
          REMOTE_PATH="${REMOTE_PATH}-${{ inputs.cache-key-suffix }}"
        fi
        echo "pushing to $REMOTE_PATH"
        packages=( $(echo ${{ inputs.persistent-packages }}) )
        for i in "${packages[@]}"; do
          time tar czf $i.tar.gz $i
          du -h $i.tar.gz
          echo "pushing persistent cache"
          time aws s3 cp --no-progress $i.tar.gz s3://${S3_BUILD_BUCKET_SHORT_NAME}/${REMOTE_PATH}/$i.tar.gz
        done


